#!/usr/bin/env bash
set -euo pipefail

echo "ğŸ” Pre-push: running CI checks and Docker tests..."

# Ensure composer deps are installed
if [ ! -d "vendor" ]; then
  echo "Installing composer dependencies..."
  if ! composer install --no-interaction --optimize-autoloader; then
    echo "âš ï¸ Composer install failed locally. Continuing to allow push (CI will run on GitHub)."
  fi
fi

echo "â–¶ï¸ Composer CI checks (lint, analyse, tests)"
if ! composer ci; then
  echo "âš ï¸ Composer CI checks failed locally. Continuing to allow push."
fi

echo "ğŸ³ Building Docker test image for pre-push..."
if command -v docker >/dev/null 2>&1; then
  docker build -f docker/Dockerfile.test -t articlesapp-test-prepush . || echo "âš ï¸ Docker build failed locally."
  echo "ğŸš€ Running tests inside Docker (pre-push)..."
  docker run --rm articlesapp-test-prepush || echo "âš ï¸ Docker tests failed locally."
else
  echo "âš ï¸ Docker not available; skipping containerized tests."
fi

echo "âœ… Pre-push completed. Proceeding with push."